CREATE PROC [dbo].[WJS_SP_FIF0010F]
	(
	@TYPE			NVARCHAR(1),
	@DATEF			NVARCHAR(8),
	@DATET			NVARCHAR(8),
	@ACCTTYPE		NVARCHAR(1),
	@ACCTLVL		NVARCHAR(1),
	@BPTYPE			NVARCHAR(1),
	@BPGROUP		NVARCHAR(10),
	@ACCTCDF		NVARCHAR(50),
	@ACCTCDT		NVARCHAR(50),
	@BPCODEF		NVARCHAR(50),
	@BPCODET		NVARCHAR(50),
	@ZEROYN			NVARCHAR(1)
	)
AS

/*

EXEC WJS_SP_FIF0010F '1','20160701','20161231','','','','','','','','','N'

*/

BEGIN
	
	IF @ACCTCDT = '' SET @ACCTCDT ='ZZZZZZZZZZZZZZZ'
	IF @BPCODET = '' SET @BPCODET ='ZZZZZZZZZZZZZZZ'

	DECLARE @TB_SUM AS TABLE	(
								ACCTCODE	NVARCHAR(50),
								ACCTNAME	NVARCHAR(100),
								BPCODE		NVARCHAR(50),
								BPNAME		NVARCHAR(50),
								OB_LC		NUMERIC(23,6),
								DEB_LC		NUMERIC(23,6),
								CRE_LC		NUMERIC(23,6),
								BAL_LC		NUMERIC(23,6),

								OB_FC		NUMERIC(23,6),
								DEB_FC		NUMERIC(23,6),
								CRE_FC		NUMERIC(23,6),
								BAL_FC		NUMERIC(23,6),

								OB_SC		NUMERIC(23,6),
								DEB_SC		NUMERIC(23,6),
								CRE_SC		NUMERIC(23,6),
								BAL_SC		NUMERIC(23,6)
								)

	IF @TYPE = '1'
	BEGIN
		INSERT INTO @TB_SUM
		SELECT	T0.Account,
				MAX(T2.AcctName) AS AcctName,
				NULL,
				NULL,
				0					AS OB_LC,
				SUM(T0.Debit)		AS DEB_LC,
				SUM(T0.Credit)		AS CRE_LC,
				0					AS BAL_LC,
				0					AS OB_FC,
				SUM(T0.FCDebit)		AS DEB_FC,
				SUM(T0.FCCredit) 	AS CRE_FC,
				0					AS BAL_FC,
				0					AS OB_SC,
				SUM(T0.SYSDeb)		AS DEB_SC,
				SUM(T0.SYSCred)		AS CRE_SC,
				0					AS BAL_SC
		FROM JDT1 T0
		INNER JOIN OJDT T1 ON T0.TransID = T1.TransID
		INNER JOIN OACT T2 ON T0.Account = T2.AcctCode
		WHERE T1.RefDate BETWEEN @DATEF AND @DATET
		AND T2.GroupMask = CASE WHEN @ACCTTYPE = '' THEN T2.GroupMask ELSE @ACCTTYPE END
		AND T2.Levels = CASE WHEN @ACCTLVL = '' THEN T2.Levels ELSE @ACCTLVL END
		AND T0.Account BETWEEN @ACCTCDF AND @ACCTCDT
		GROUP BY T0.Account

		UNION ALL

		SELECT	T0.Account,
				MAX(T2.AcctName) AS AcctName,
				NULL,
				NULL,
				SUM(T0.Debit - T0.Credit)		AS OB_LC,
				0,0,0,
				SUM(T0.FCDebit - T0.FCCredit)	AS OB_FC,
				0,0,0,
				SUM(T0.SYSDeb - T0.SYSCred)		AS OB_SC,
				0,0,0
		FROM JDT1 T0
		INNER JOIN OJDT T1 ON T0.TransID = T1.TransID
		INNER JOIN OACT T2 ON T0.Account = T2.AcctCode
		WHERE T1.RefDate < @DATEF
		AND T2.GroupMask = CASE WHEN @ACCTTYPE = '' THEN T2.GroupMask ELSE @ACCTTYPE END
		AND T2.Levels = CASE WHEN @ACCTLVL = '' THEN T2.Levels ELSE @ACCTLVL END
		AND T0.Account BETWEEN @ACCTCDF AND @ACCTCDT
		GROUP BY T0.Account

		IF @ZEROYN = 'Y'
		BEGIN
			SELECT	T0.ACCTCODE,
					MAX(T0.ACCTNAME)	AS ACCTNAME,
					SUM(T0.OB_LC)		AS OB_LC,
					SUM(T0.DEB_LC)		AS DEB_LC,
					SUM(T0.CRE_LC)		AS CRE_LC,
					SUM(T0.OB_LC + (T0.DEB_LC + T0.CRE_LC))		AS BAL_LC,

					SUM(T0.OB_FC)		AS OB_FC,
					SUM(T0.DEB_FC)		AS DEB_FC,
					SUM(T0.CRE_FC)		AS CRE_FC,
					SUM(T0.OB_FC + (T0.DEB_FC + T0.CRE_FC))		AS BAL_FC,

					SUM(T0.OB_SC)		AS OB_SC,
					SUM(T0.DEB_SC)		AS DEB_SC,
					SUM(T0.CRE_SC)		AS CRE_SC,
					SUM(T0.OB_SC + (T0.DEB_SC + T0.CRE_SC))		AS BAL_SC
			FROM @TB_SUM T0
			GROUP BY T0.ACCTCODE
			HAVING SUM(T0.OB_LC + (T0.DEB_LC + T0.CRE_LC)) <> 0
			ORDER BY T0.ACCTCODE
		END
		ELSE
		BEGIN
			SELECT	T0.ACCTCODE,
					MAX(T0.ACCTNAME)	AS ACCTNAME,
					SUM(T0.OB_LC)		AS OB_LC,
					SUM(T0.DEB_LC)		AS DEB_LC,
					SUM(T0.CRE_LC)		AS CRE_LC,
					SUM(T0.OB_LC + (T0.DEB_LC + T0.CRE_LC))		AS BAL_LC,

					SUM(T0.OB_FC)		AS OB_FC,
					SUM(T0.DEB_FC)		AS DEB_FC,
					SUM(T0.CRE_FC)		AS CRE_FC,
					SUM(T0.OB_FC + (T0.DEB_FC + T0.CRE_FC))		AS BAL_FC,

					SUM(T0.OB_SC)		AS OB_SC,
					SUM(T0.DEB_SC)		AS DEB_SC,
					SUM(T0.CRE_SC)		AS CRE_SC,
					SUM(T0.OB_SC + (T0.DEB_SC + T0.CRE_SC))		AS BAL_SC
			FROM @TB_SUM T0
			GROUP BY T0.ACCTCODE
			ORDER BY T0.ACCTCODE
		END


				
	END
	ELSE
	BEGIN

		INSERT INTO @TB_SUM
		SELECT	T0.Account,
				MAX(T2.AcctName)	AS AcctName,
				T3.CardCode,
				MAX(T3.CardName)	AS CardName,
				0					AS OB_LC,
				SUM(T0.Debit)		AS DEB_LC,
				SUM(T0.Credit)		AS CRE_LC,
				0					AS BAL_LC,
				0					AS OB_FC,
				SUM(T0.FCDebit)		AS DEB_FC,
				SUM(T0.FCCredit) 	AS CRE_FC,
				0					AS BAL_FC,
				0					AS OB_SC,
				SUM(T0.SYSDeb)		AS DEB_SC,
				SUM(T0.SYSCred)		AS CRE_SC,
				0					AS BAL_SC
		FROM JDT1 T0
		INNER JOIN OJDT T1 ON T0.TransID = T1.TransID
		INNER JOIN OACT T2 ON T0.Account = T2.AcctCode
		INNER JOIN OCRD T3 ON T0.ShortName = T3.CardCode
		WHERE T1.RefDate BETWEEN @DATEF AND @DATET
		AND T2.GroupMask = CASE WHEN @ACCTTYPE = '' THEN T2.GroupMask ELSE @ACCTTYPE END
		AND T2.Levels = CASE WHEN @ACCTLVL = '' THEN T2.Levels ELSE @ACCTLVL END
		AND T0.Account BETWEEN @ACCTCDF AND @ACCTCDT
		AND T3.CardType = CASE WHEN @BPTYPE = '' THEN T3.CardType ELSE @BPTYPE END
		AND T3.GroupCode = CASE WHEN @BPGROUP = '' THEN T3.GroupCode ELSE @BPGROUP END
		AND T3.CardCode BETWEEN @BPCODEF AND @BPCODET
		GROUP BY T0.Account, T3.CardCode

		UNION ALL

		SELECT	T0.Account,
				MAX(T2.AcctName)	AS AcctName,
				T3.CardCode,
				MAX(T3.CardName)	AS CardName,
				SUM(T0.Debit - T0.Credit)		AS OB_LC,
				0,0,0,
				SUM(T0.FCDebit - T0.FCCredit)	AS OB_FC,
				0,0,0,
				SUM(T0.SYSDeb - T0.SYSCred)		AS OB_SC,
				0,0,0
		FROM JDT1 T0
		INNER JOIN OJDT T1 ON T0.TransID = T1.TransID
		INNER JOIN OACT T2 ON T0.Account = T2.AcctCode
		INNER JOIN OCRD T3 ON T0.ShortName = T3.CardCode
		WHERE T1.RefDate < @DATEF
		AND T2.GroupMask = CASE WHEN @ACCTTYPE = '' THEN T2.GroupMask ELSE @ACCTTYPE END
		AND T2.Levels = CASE WHEN @ACCTLVL = '' THEN T2.Levels ELSE @ACCTLVL END
		AND T0.Account BETWEEN @ACCTCDF AND @ACCTCDT
		AND T3.CardType = CASE WHEN @BPTYPE = '' THEN T3.CardType ELSE @BPTYPE END
		AND T3.GroupCode = CASE WHEN @BPGROUP = '' THEN T3.GroupCode ELSE @BPGROUP END
		AND T3.CardCode BETWEEN @BPCODEF AND @BPCODET

		GROUP BY T0.Account, T3.CardCode

		IF @ZEROYN = 'Y'
		BEGIN
			SELECT	T0.BPCODE,
					MAX(T0.BPNAME)		AS BPNAME,
					T0.ACCTCODE,
					MAX(T0.ACCTNAME)	AS ACCTNAME,
					SUM(T0.OB_LC)		AS OB_LC,
					SUM(T0.DEB_LC)		AS DEB_LC,
					SUM(T0.CRE_LC)		AS CRE_LC,
					SUM(T0.OB_LC + (T0.DEB_LC + T0.CRE_LC))		AS BAL_LC,

					SUM(T0.OB_FC)		AS OB_FC,
					SUM(T0.DEB_FC)		AS DEB_FC,
					SUM(T0.CRE_FC)		AS CRE_FC,
					SUM(T0.OB_FC + (T0.DEB_FC + T0.CRE_FC))		AS BAL_FC,

					SUM(T0.OB_SC)		AS OB_SC,
					SUM(T0.DEB_SC)		AS DEB_SC,
					SUM(T0.CRE_SC)		AS CRE_SC,
					SUM(T0.OB_SC + (T0.DEB_SC + T0.CRE_SC))		AS BAL_SC
			FROM @TB_SUM T0
			GROUP BY T0.BPCODE, T0.ACCTCODE
			HAVING SUM(T0.OB_LC + (T0.DEB_LC + T0.CRE_LC))	<> 0
			ORDER BY T0.BPCODE, T0.ACCTCODE
		END
		ELSE
		BEGIN
			SELECT	T0.BPCODE,
					MAX(T0.BPNAME)		AS BPNAME,
					T0.ACCTCODE,
					MAX(T0.ACCTNAME)	AS ACCTNAME,
					
					SUM(T0.OB_LC)		AS OB_LC,
					SUM(T0.DEB_LC)		AS DEB_LC,
					SUM(T0.CRE_LC)		AS CRE_LC,
					SUM(T0.OB_LC + (T0.DEB_LC + T0.CRE_LC))		AS BAL_LC,

					SUM(T0.OB_FC)		AS OB_FC,
					SUM(T0.DEB_FC)		AS DEB_FC,
					SUM(T0.CRE_FC)		AS CRE_FC,
					SUM(T0.OB_FC + (T0.DEB_FC + T0.CRE_FC))		AS BAL_FC,

					SUM(T0.OB_SC)		AS OB_SC,
					SUM(T0.DEB_SC)		AS DEB_SC,
					SUM(T0.CRE_SC)		AS CRE_SC,
					SUM(T0.OB_SC + (T0.DEB_SC + T0.CRE_SC))		AS BAL_SC
			FROM @TB_SUM T0
			GROUP BY T0.BPCODE, T0.ACCTCODE
			ORDER BY T0.BPCODE, T0.ACCTCODE
		END

	END

END
